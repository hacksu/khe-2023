name: CI/CD

on:
  workflow_dispatch:
  push:

jobs:
  lint:
    name: Lint
    uses: hacksu/khe-2023/.github/workflows/lint.yml@deployment

  build:
    name: Build
    needs: [lint]
    uses: hacksu/khe-2023/.github/workflows/build.yml@deployment

  # prepublish:
  #   name: Publish
  #   needs: [lint]
  #   uses: hacksu/khe-2023/.github/workflows/prepublish.yml@deployment

  publish:
    name: Publish
    if: github.ref == 'refs/heads/main' && needs.build.outputs.publish == 'true'
    needs: [build]
    uses: hacksu/khe-2023/.github/workflows/publish.yml@deployment
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/deployment' && (true || github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '@deploy'))
    needs: [build]
    # uses: hacksu/khe-2023/.github/workflows/deploy.yml@deployment
    uses: ./.github/workflows/cdeploy.yml.yml
    secrets:
      host: ${{ secrets.KHE_DEV_HOST }} 
      key: ${{ secrets.KHE_DEV_KEY }}
    with:
      directory: /opt/khe/khe-2023
      

  health:
    name: Health
    needs: [build, publish, deploy]
    if: ${{ always() }}
    uses: hacksu/khe-2023/.github/workflows/health.yml@deployment
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}